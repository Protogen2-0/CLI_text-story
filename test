const fs = require('fs');
const readline = require('readline')
const prompt = (msg) => {
  fs.writeSync(1, msg);
  let str = '', buffer = Buffer.alloc(1);
  
  while (true) {
    const bytesRead = fs.readSync(0, buffer, 0, 1);
    const charCode = buffer[0];

    // 10 - это '\n' (Linux/macOS/Windows), 13 - это '\r' (Windows)
    if (bytesRead === 0 || charCode === 10 || charCode === 13) {
      // Если это \r, проверяем, нет ли следом \n, чтобы очистить поток в Windows
      if (charCode === 13) {
        try { fs.readSync(0, buffer, 0, 1); } catch(e) {}
      }
      break;
    }
    str += buffer.toString();
  }
  return str;
};

let prevLogs = "";
function clear(){
    console.clear()
    console.log(prevLogs)
}

let width = process.stdout.columns
let heigth = process.stdout.rows
process.stdout.on("resize", ()=>{
    width = process.stdout.columns
    heigth = process.stdout.rows
})

function sleep (ms) {
  Atomics.wait(new Int32Array(new SharedArrayBuffer(4)), 0, 0, ms);
}

function slowPrint(str, shouldDisplayPrevLogs, shouldIncreacePrevLogs, shouldDeletePrevLogs){
    let effects = ""
    stringEffects.forEach(e=>effects = effects + e)
    if(!shouldDisplayPrevLogs){
        for(let i = 0; i < str.length + 1; i++){
            console.clear()
            console.log(effects + str.substring(0, i) + "\x1b[0m")
            if( str[i] === "." ) sleep(350) 
            else if( str[i] === "," ) sleep(200)
            else sleep(20)
        }
    }
    else{
        for(let i = 0; i < str.length + 1; i++){
            console.clear()
            console.log(prevLogs + effects + str.substring(0, i) + "\x1b[0m")
            if( str[i] === "." ) sleep(350) 
            else if( str[i] === "," ) sleep(200)
            else sleep(20)
        }
    }
    if(shouldDeletePrevLogs) prevLogs = ""
    if(shouldIncreacePrevLogs) prevLogs = prevLogs + effects + str + "\x1b[0m"
}

function addEffectBasedOnWhatToChange(str, whatToChange, isCustom, canIgnoreNonExistPath){
    if(!isCustom){
        switch(whatToChange){
            case("text"):
                stringEffects.push(`\x1b[3${str}m`)
                break
            case("underline"):
                stringEffects.push(`\x1b[4;3${str}m`)
                break
            case("background"):
                stringEffects.push(`\x1b[4${str}m`)
                break
            case("intensive background"):
                stringEffects.push(`\x1b[10${str}m`)
                break
            case("bold"):
                stringEffects.push(`\x1b[1;3${str}m`)
                break
            case("intensity"):
                stringEffects.push(`\x1b[0;9${str}m`)
                break
        }
    }
    else {
        switch(whatToChange){
            case("text"):
                stringEffects.push(`\x1b[38;2;${str}m`)
                break
            case("underline"):
                stringEffects.push(`\x1b[4;38;2;${str}m`)
                break
            case("background"):
                stringEffects.push(`\x1b[48;2;${str}m`)
                break
            case("intensive background"):
                if(canIgnoreNonExistPath){
                    stringEffects.push(`\x1b[48;2;${str}m`)
                    break
                }
            case("bold"):
                if(canIgnoreNonExistPath){
                    stringEffects.push(`\x1b[38;2;${str}m`)
                    break
                }
            case("intensity"):
                if(canIgnoreNonExistPath){
                    stringEffects.push(`\x1b[38;2;${str}m`)
                    break
                }
        }
    }
}

function changeColor(startText, colorText, whatToChange, canIgnoreNonExistPath){
    slowPrint( startText , false, true, true)
    while(true){
        let color = prompt("")
        if( ["0","1","2","3","4","5","6","7","8"].includes(color) ){
            if(color !== "8") addEffectBasedOnWhatToChange(color, whatToChange, false, canIgnoreNonExistPath)
            switch(color){
                case("0"):
                    slowPrint("now you've " + colorText + "...black!) \n"+
                    "neat choise...even though you cant see it...", false, false, true)
                    break
                case("1"):
                    slowPrint("now you've " + colorText + "...red!) \n"+
                    "wow, pretty scary if i say so, you love blood i guess", false, false, true)
                    break
                case("2"):
                    slowPrint("now you've " + colorText + "...green!) \n"+
                    "green light for you and your new text format)", false, false, true)
                    break
                case("3"):
                    slowPrint("now you've " + colorText + "...yellow!) \n"+
                    ".....why this color?...", false, false, true)
                    break
                case("4"):
                    slowPrint("now you've " + colorText + "...blue!) \n"+
                    "ahhh... sky's color, sweet and common", false, false, true)
                    break
                case("5"):
                    slowPrint("now you've " + colorText + "...purple!) \n"+
                    "between blue and red, couldn't decided what to pick hehe", false, false, true)
                    break
                case("6"):
                    slowPrint("now you've " + colorText + "...cyan!) \n"+
                    "nothing to say except it's my favourite color)", false, false, true)
                    break
                case("7"):
                    slowPrint("now you've " + colorText + "...to......white...?... \n"+
                    "i dont whink i needed to implement this and waste my and your time on this...", false, false, true)
                    break
                case("8"):
                    slowPrint("seems that you need spetial color... \n"+
                    "either you choose hex format or rgb, what do you prefer more?... \n"+
                    "0 - hex format ( #------ ) \n1 - rgb format ( ---;---;--- )", false, true, true)
                    while(true){
                        let paramChoise = prompt("")
                        if(paramChoise === "0"){
                            slowPrint("enter your hex string ( #------ ) : \n", false, true, true)
                            while(true){
                                let hexStr = prompt("")
                                if( /^\#?[0-9A-F]{6}$/i.test(hexStr) ){
                                    if(hexStr.includes("#")) hexStr = hexStr.replace("#", "")
                                    hexStr = parseInt( hexStr.substr(0,2), 16 ) + ";" +
                                    parseInt( hexStr.substr(2, 2), 16 ) + ";" +
                                    parseInt( hexStr.substr(4, 2), 16 )
                                    addEffectBasedOnWhatToChange(hexStr, whatToChange, true, canIgnoreNonExistPath)
                                    slowPrint("now you've " + colorText + `...to...rgb(${hexStr})\n`+
                                    "very creative, good job!", false, false, true)
                                    break
                                }
                            }
                            break
                        }
                        if(paramChoise === "1"){
                            slowPrint("enter your rgb string ( ---;---;--- ) : \n", false, true, true)
                            while(true){
                                let rgbStr = prompt("")
                                if( /^\d{1,3};\d{1,3};\d{1,3}$/.test(rgbStr) ){
                                    addEffectBasedOnWhatToChange(rgbStr, whatToChange, true, canIgnoreNonExistPath)
                                    slowPrint("now you've " + colorText + `...to...rgb(${rgbStr})\n`+
                                    "very creative, good job!", false, false, true)
                                    break
                                }


                            }
                            break
                        }
                        clear()
                    }
                    break
            }
            break
        }
        clear()
    }
}

let stringEffects = [] /* "\x1b[0;0;37;40m \x1b[0m"   

                                                      /\x1b\[(?:3[0-7]|38;2;\d{1,3};\d{1,3};\d{1,3}|38;5;\d{1,3}|9[0-7])m/g 
                                ^ ^ ^^ ^^         
                                 \ \ \\ \\__     color          black       - 0  |  provided colors - 0-7 | custom > ...8;5;x | ...8;2;x;x;x  =>  x(0,255)   
                                  \ \ \\ \__   intensity     not intensity  - 4  |        high      - 10
                                   \ \ \\___     color          white       - 7  |  provided colors - 0-7 | custom > ...8;5;x | ...8;2;x;x;x  =>  x(0,255)   
                                    \ \ \___   intensity     not intensity  - 3  |        high      - 9
                                     \ \____     bold          not bold     - 0  |        bold      - 1
                                      \_____   underline     no underline   - 0  |     underlined   - 4
                        */

                        function parseAnsi(ansi) {
  const paramsMatch = ansi.match(/\x1b\[([0-9;]+)m/);
  if (!paramsMatch) return { text: null, bg: null };
  const params = paramsMatch[1].split(';');

  let textParams = [];
  let bgParams = [];
  let i = 0;

  while (i < params.length) {
    const param = params[i];
    // Текст: 30-37, 90-97, 38;2;r;g;b, 38;5;index
    if (param === '38' || param === '9') {
      if (params[i+1] === '2' || params[i+1] === '5') {
        textParams.push([param, params[i+1], params[i+2], params[i+3], params[i+4]].join(';'));
        i += 5;
      } else {
        textParams.push(param);
        i += 1;
      }
    } else if (param.match(/^3[0-7]$/) || param.match(/^9[0-7]$/)) {
      textParams.push(param);
      i += 1;
    }
    // Фон: 40-47, 100-107, 48;2;r;g;b, 48;5;index
    else if (param === '48' || param === '10') {
      if (params[i+1] === '2' || params[i+1] === '5') {
        bgParams.push([param, params[i+1], params[i+2], params[i+3], params[i+4]].join(';'));
        i += 5;
      } else {
        bgParams.push(param);
        i += 1;
      }
    } else if (param.match(/^4[0-7]$/) || param.match(/^10[0-7]$/)) {
      bgParams.push(param);
      i += 1;
    }
    // Игнорируем остальные параметры (0, 1, 4, 7, etc.)
    else {
      i += 1;
    }
  }

  return {
    text: textParams.length ? textParams.join(';') : null,
    bg: bgParams.length ? bgParams.join(';') : null,
  };
}

// Примеры
console.log(parseAnsi("\x1b[4;0;48;2;32;232;22;33m"));
// { text: '33', bg: '48;2;32;232;22' }

console.log(parseAnsi("\x1b[0;1;31;48;5;240m"));
// { text: '31', bg: '48;5;240' }

console.log(parseAnsi("\x1b[38;2;255;100;0;4;48;2;0;0;255m"));
// { text: '38;2;255;100;0', bg: '48;2;0;0;255' }


function start(){
    clear()
    slowPrint("hello, user, let's change your configuration... \n", false, false, true)
    sleep(500)
    slowPrint("first of all, let's see what we can change... \n\n", true, true, true)
    sleep(500)
    slowPrint("\x1b[4;35;42m what ? \x1b[0m \n\n", true, true, false)
    sleep(200)
    slowPrint("\x1b[4;34m underline ? \x1b[0m \n\n", true, true, false)
    sleep(200)
    slowPrint("\x1b[0;45m background ? \x1b[0m \n\n", true, true, false)
    sleep(200)
    slowPrint("\x1b[1;33m boldness ? \x1b[0m \n\n", true, true, false)
    sleep(200)
    slowPrint("you can do whatever you want, so... in what you're intrested in?... \n\n" +
        "1 - regular text color \n2 - add underline (this will change text color too, be careful) \n" + 
        "3 - change background \n4 - add smth different (and less noticable) \n", true, true, false)
    let ans = ""
    while(!["1","2","3","4"].includes(ans)){
        ans = prompt("")
        switch(ans){
            case("1"):
                changeColor("good choice, as well as very basic change... \n"+
                    "there is many colors to pick, ranged from black to white, what color do you want?... \n\n"+
                    "0 - black \n1 - red \n2 - green \n3 - yellow \n4 - blue \n"+
                    "5 - purple \n6 - cyan \n7 - white (default) \n8 - custom color", "changed text color to", "text", true)
                break
            case("2"):
                changeColor("wanted to see text better? It's your choise I don't mind)... \n"+
                "underline text has so much colors so...what color do you want?... \n\n"+
                "0 - black \n1 - red \n2 - green \n3 - yellow \n4 - blue \n"+
                "5 - purple \n6 - cyan \n7 - white \n8 - custom color", "changed underline color to", "underline", true)
                break
            case("3"):
                slowPrint("there is 2 types of background colors, regular and 'intensive', what do you want? \n"+
                "1 - default \n2 - intensive", false, true, true)
                while(true){
                    let bgChoise = prompt("")
                    if(bgChoise === "1"){
                        changeColor("you either want to REALLY see the text or you just want to highlight important moments\n"+
                        "there is many colors to pick, ranged from black to white, what color do you want?... \n\n"+
                        "0 - black (default) \n1 - red \n2 - green \n3 - yellow \n4 - blue \n"+
                        "5 - purple \n6 - cyan \n7 - white \n8 - custom color", "changed background color to", "background", true)
                        break
                    }
                    if(bgChoise === "2"){
                        slowPrint("WARNING... intensive background colors don't have custom colors, you can choose to ignore it.. \n\n"+
                        "1 - true - ingore warning ( when using custom colors, selected color will apply as usual ) \n"+
                        "0 - false - don't change color if you pick custom color option", false, true, true)
                        while(true){
                            let isIgnoring = prompt("")
                            if(isIgnoring === "1" || isIgnoring === "0"){
                                changeColor("wanted to see text better? It's your choise, I don't mind)... \n"+
                                "background has so much colors so...what color do you want?... \n\n"+
                                "0 - black \n1 - red \n2 - green \n3 - yellow \n4 - blue \n"+
                                "5 - purple \n6 - cyan \n7 - white (default) \n8 - custom color", "changed background color to", "intensive background", isIgnoring === "1" ? true : false)
                                break
                            }
                            clear()
                        }
                        break
                    }
                    clear()
                }
                break
            case("4"):
                //
                break
            default:
                clear()
        }
    }
    console.log("end")
}
start()

/[(3[([0-7])(8;[(2;\d{1,3};\d{1,3};\d{1,3})(5;\d{1,3})])])(9[0-7])]/
